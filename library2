-- LuaLibrary Module - Universal Drag (PC & Mobile), PascalCase, Dark/Transparent Theme, STABLE
-- EXECUTE BUTTON REMOVED for a cleaner interface.

local Library = {}

-- Secure service references with error handling
local function GetService(ServiceName)
    local Success, Result = pcall(function()
        return game:GetService(ServiceName)
    end)
    return Success and Result or error("Failed to get service: " .. ServiceName)
end

local Players = GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TweenService = GetService("TweenService")
local UserInputService = GetService("UserInputService")

-- Configuration and Theme
local Config = {
    Name = "LuaLibrary",
    Theme = {
        Background = Color3.fromRGB(30, 30, 30), 
        Accent = Color3.fromRGB(0, 0, 0),
        Frame = Color3.fromRGB(30, 30, 30),
        Text = Color3.fromRGB(255, 255, 255),
        Transparency = 0.650, -- Controls transparency for buttons, tabs, etc.
        CornerRadius = 5,
        WindowSize = UDim2.new(0, 333, 0, 189),
        TitleHeight = 35,
        ElementHeight = 27,
        Padding = 8,
        TabWidth = 100,
    }
}

-- Library State
local State = {
    ScreenGui = nil,
    MainFrame = nil,
    TabFrame = nil,    
    PageContainer = nil,
    Pages = {},          
    CurrentTabButton = nil,
    RequiredGroupId = nil,
    GroupChecked = false,
    IsInGroup = false,
    IsMinimized = false,
    MinimizeButton = nil,
    
    -- NEW SEARCH STATE
    SearchFrame = nil,
    SearchTextBox = nil,
    SearchFrameHiddenPos = UDim2.new(1, -30, 0, 0), -- Position when hidden (right edge)
    SearchFrameVisiblePos = UDim2.new(0, 30, 0, 0), -- Position when visible (left-aligned, but shifted right by the icon)
    SearchIcon = nil,
}

----------------------------------------------------------------------
-- SECURE UTILITY FUNCTIONS
----------------------------------------------------------------------

local function CreateInstance(ClassName, Properties)
    local Success, Instance_ = pcall(function()
        local Obj = Instance.new(ClassName)
        for Prop, Value in pairs(Properties) do
            local SetSuccess = pcall(function()
                Obj[Prop] = Value
            end)
            if not SetSuccess then
                warn("Failed to set property " .. tostring(Prop) .. " on " .. ClassName)
            end
        end
        return Obj
    end)
    
    if not Success then
        error("Failed to create instance: " .. ClassName)
        return nil
    end
    
    -- Apply general transparency safely
    if Instance_ and Instance_:IsA("GuiObject") and not Properties.BackgroundTransparency then
        pcall(function()
            Instance_.BackgroundTransparency = Config.Theme.Transparency -- Applies 0.650
        end)
    end
    
    return Instance_
end

local function ApplyCorner(Instance_, Radius)
    return CreateInstance("UICorner", {
        CornerRadius = UDim.new(0, Radius or Config.Theme.CornerRadius),
        Parent = Instance_,
    })
end

-- Universal Drag Support (PC & Mobile) - Obfuscation Safe
local function SetupDragging(DragInstance, MainInstance)
    local Dragging = false
    local DragStart = nil
    local FrameStart = nil
    
    local function IsDragInput(Input)
        return Input.UserInputType == Enum.UserInputType.MouseButton1 
            or Input.UserInputType == Enum.UserInputType.Touch
    end

    local function SafeTween(Position)
        pcall(function()
            TweenService:Create(MainInstance, TweenInfo.new(0.1), {Position = Position}):Play()
        end)
    end

    pcall(function()
        DragInstance.InputBegan:Connect(function(Input)
            if IsDragInput(Input) then
                Dragging = true
                DragStart = Input.Position
                FrameStart = MainInstance.Position
            end
        end)

        UserInputService.InputChanged:Connect(function(Input)
            if Dragging and IsDragInput(Input) then
                local Delta = Input.Position - DragStart
                local NewPos = UDim2.new(
                    FrameStart.X.Scale, FrameStart.X.Offset + Delta.X,
                    FrameStart.Y.Scale, FrameStart.Y.Offset + Delta.Y
                )
                SafeTween(NewPos)
            end
        end)
        
        UserInputService.InputEnded:Connect(function(Input)
            if IsDragInput(Input) and Dragging then
                Dragging = false
            end
        end)
    end)
end

-- Minimize/Maximize Function
local function ToggleMinimize()
    if not State.MainFrame or not State.MinimizeButton then return end
    
    State.IsMinimized = not State.IsMinimized
    
    if State.IsMinimized then
        -- Minimize: Hide content, show only title bar
        State.MinimizeButton.Text = "+"
        TweenService:Create(State.MainFrame, TweenInfo.new(0.3), {
            Size = UDim2.new(0, 200, 0, Config.Theme.TitleHeight)
        }):Play()
        
        -- Hide content
        State.TabFrame.Visible = false
        State.PageContainer.Visible = false
    else
        -- Maximize: Show full content
        State.MinimizeButton.Text = "-"
        TweenService:Create(State.MainFrame, TweenInfo.new(0.3), {
            Size = Config.Theme.WindowSize
        }):Play()
        
        -- Show content
        State.TabFrame.Visible = true
        State.PageContainer.Visible = true
    end
end

-- Group Verification System
local function CheckGroupMembership(GroupId)
    local inGroup = false
    pcall(function()
        if LocalPlayer then
            inGroup = LocalPlayer:IsInGroup(GroupId)
        end
    end)
    return inGroup
end

local function CreateGroupJoinGUI(GroupId)
    if State.MainFrame then
        State.MainFrame:Destroy()
        State.MainFrame = nil
    end
    
    -- Create new interface for group join
    local PlayerGui
    pcall(function()
        PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
    end)
    
    if not PlayerGui then return end
    
    local LibraryGui = CreateInstance("ScreenGui", {
        Name = "GroupJoinInterface",
        Parent = PlayerGui,
        DisplayOrder = 100,
    })
    
    local MainFrame = CreateInstance("Frame", {
        Name = "Main",
        Parent = LibraryGui,
        BackgroundColor3 = Config.Theme.Background,
        Size = UDim2.new(0, 300, 0, 200),
        Position = UDim2.new(0.5, -150, 0.5, -100),
        BorderSizePixel = 0,
    })
    ApplyCorner(MainFrame)
    State.MainFrame = MainFrame

    -- Title Bar
    local TitleBar = CreateInstance("Frame", {
        Name = "TitleBar",
        Parent = MainFrame,
        BackgroundColor3 = Config.Theme.Accent,
        BackgroundTransparency = 0.3,
        Size = UDim2.new(1, 0, 0, Config.Theme.TitleHeight),
        BorderSizePixel = 0,
    })
    
    CreateInstance("TextLabel", {
        Parent = TitleBar,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = "Group",
        TextColor3 = Config.Theme.Text,
        Font = Enum.Font.SourceSansBold,
        TextSize = 20,
        TextXAlignment = Enum.TextXAlignment.Center,
    })

    SetupDragging(TitleBar, MainFrame)

    -- Tab Container
    local TabFrame = CreateInstance("Frame", {
        Name = "TabFrame",
        Parent = MainFrame,
        BackgroundColor3 = Config.Theme.Frame,
        BackgroundTransparency = 1,
        Size = UDim2.new(0, Config.Theme.TabWidth, 1, -Config.Theme.TitleHeight),
        Position = UDim2.new(0, 0, 0, Config.Theme.TitleHeight),
        BorderSizePixel = 0,
    })
    
    -- Page Container
    local PageContainer = CreateInstance("Frame", {
        Name = "PageContainer",
        Parent = MainFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -Config.Theme.TabWidth, 1, -Config.Theme.TitleHeight),
        Position = UDim2.new(0, Config.Theme.TabWidth, 0, Config.Theme.TitleHeight),
        BorderSizePixel = 0,
    })
    
    -- Create Join Tab
    local JoinTabButton = CreateInstance("TextButton", {
        Name = "JoinTab",
        Parent = TabFrame,
        BackgroundColor3 = Config.Theme.Frame,
        Size = UDim2.new(1, 0, 0, Config.Theme.ElementHeight),
        Position = UDim2.new(0, 0, 0, 0),
        Text = "Join",
        TextColor3 = Config.Theme.Text,
        Font = Enum.Font.SourceSansBold,
        TextSize = 15,
        BorderSizePixel = 0,
    })
    
    -- Create Join Page
    local JoinPage = CreateInstance("ScrollingFrame", {
        Name = "JoinPage",
        Parent = PageContainer,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        Active = true,
        Visible = true,
        ScrollBarImageColor3 = Color3.fromRGB(200, 200, 200),
        ScrollBarThickness = 6,
    })
    
    local YOffset = Config.Theme.Padding
    
    local function AddButton(Text, Callback, HeightMultiplier)
        local ElementFrame = CreateInstance("Frame", {
            Name = "ElementFrame",
            Parent = JoinPage,
            BackgroundColor3 = Config.Theme.Frame,
            Size = UDim2.new(1, -2 * Config.Theme.Padding, 0, Config.Theme.ElementHeight * (HeightMultiplier or 1)),
            Position = UDim2.new(0, Config.Theme.Padding, 0, YOffset),
            BorderSizePixel = 0,
        })
        ApplyCorner(ElementFrame)
        
        local Button = CreateInstance("TextButton", {
            Name = "Button",
            Parent = ElementFrame,
            BackgroundColor3 = Config.Theme.Frame,
            Size = UDim2.new(1, 0, 1, 0),
            Text = Text,
            Font = Enum.Font.SourceSans,
            TextSize = 14,
            TextColor3 = Config.Theme.Text,
        })
        
        if Callback then
            pcall(function()
                Button.MouseButton1Click:Connect(function()
                    pcall(Callback)
                end)
            end)
        end
        
        YOffset = YOffset + Config.Theme.ElementHeight * (HeightMultiplier or 1) + Config.Theme.Padding
        JoinPage.CanvasSize = UDim2.new(0, 0, 0, YOffset + Config.Theme.Padding)
        
        return Button
    end
    
    -- Add group join buttons to Join tab
    AddButton("Copy Group Link", function()
        local groupLink = "https://www.roblox.com/groups/" .. tostring(GroupId)
        if setclipboard then
            setclipboard(groupLink)
        elseif writeclipboard then
            writeclipboard(groupLink)
        end
    end)
    
    return LibraryGui
end

----------------------------------------------------------------------
-- NEW SEARCH UTILITIES
----------------------------------------------------------------------

local function **ToggleSearchBar**(IsVisible)
    local TargetPos = IsVisible and State.SearchFrameVisiblePos or State.SearchFrameHiddenPos
    
    pcall(function()
        TweenService:Create(State.SearchFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Position = TargetPos
        }):Play()
    end)
    
    if IsVisible and State.SearchTextBox then
        -- Important: Connect focus to the textbox
        pcall(function()
            State.SearchTextBox:CaptureFocus()
        end)
    end
end

local function **SearchGUI**(SearchQuery)
    local query = SearchQuery:lower()
    local foundElements = {}

    -- Only search if a query exists
    if #query < 1 then
        return foundElements
    end
    
    -- Define element types to search for (case-insensitive search against their name and text)
    local searchClasses = {
        ["TextButton"] = true, 
        ["TextBox"] = true, 
        ["TextLabel"] = true, 
        ["ImageButton"] = true,
        ["Frame"] = true, -- Include frames/containers
    }

    -- Recursive function to walk through the GUI
    local function **RecursiveSearch**(parent)
        for _, child in pairs(parent:GetChildren()) do
            -- Optimization: only check descendants of the main GUI frames
            if child:IsA("GuiObject") and child.Parent:IsDescendantOf(State.MainFrame) then
                local className = child.ClassName
                local name = child.Name:lower()
                local text = child:FindFirstChild("Text") and child.Text:lower() or ""

                -- Check if the class is in our list and the name/text matches the query
                if searchClasses[className] and (name:find(query, 1, true) or text:find(query, 1, true)) then
                    table.insert(foundElements, child)
                end
            end
            
            -- Recursively search children
            if #child:GetChildren() > 0 then
                RecursiveSearch(child)
            end
        end
    end

    -- Start the search from the main elements that hold all tabs and pages
    if State.TabFrame then RecursiveSearch(State.TabFrame) end
    if State.PageContainer then RecursiveSearch(State.PageContainer) end

    -- You would typically display these results in a separate search results window.
    -- For this simple implementation, let's just print them to the console.
    print("--- Search Results for: '" .. SearchQuery .. "' ---")
    if #foundElements > 0 then
        for _, element in ipairs(foundElements) do
            print(string.format("Found: %s (Type: %s, Parent: %s)", element.Name, element.ClassName, element.Parent.Name))
        end
    else
        print("No matching elements found.")
    end
    print("---------------------------------------")
    
    return foundElements
end

----------------------------------------------------------------------
-- CORE WINDOW & TAB MANAGEMENT
----------------------------------------------------------------------

function Library.SetGroup(GroupId)
    State.RequiredGroupId = GroupId
    State.GroupChecked = false
    State.IsInGroup = false
    return Library
end

function Library.Create(Title)
    if State.MainFrame then return Library end 
    
    -- Check group membership if required (omitted for brevity, assume code from before)
    -- ...
    
    -- If group is required and user is not in group, show group join GUI (omitted for brevity, assume code from before)
    -- ...
    
    local PlayerGui
    pcall(function()
        PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
    end)
    
    if not PlayerGui then
        warn("Failed to access PlayerGui")
        return Library
    end
    
    -- 1. ScreenGui
    local LibraryGui = CreateInstance("ScreenGui", {
        Name = Config.Name,
        Parent = PlayerGui,
        DisplayOrder = 100,
    })
    State.ScreenGui = LibraryGui

    -- 2. Main Frame (Window)
    local MainFrame = CreateInstance("Frame", {
        Name = "Main",
        Parent = LibraryGui,
        BackgroundColor3 = Config.Theme.Background,
        Size = Config.Theme.WindowSize,
        Position = UDim2.new(0.5, -Config.Theme.WindowSize.X.Offset / 2, 0.5, -Config.Theme.WindowSize.Y.Offset / 2),
        BorderSizePixel = 0,
    })
    ApplyCorner(MainFrame)
    State.MainFrame = MainFrame

    -- 3. Title Bar (Now acts as the full dragger)
    local TitleBar = CreateInstance("Frame", {
        Name = "TitleBar",
        Parent = MainFrame,
        BackgroundColor3 = Config.Theme.Accent,
        BackgroundTransparency = 0.3, -- Transparency of the drag bar (Player Utilities Part) is KEPT at 0.3
        Size = UDim2.new(1, 0, 0, Config.Theme.TitleHeight),
        BorderSizePixel = 0,
    })
    
    -- Title Label (takes 100% width - CENTERED)
    CreateInstance("TextLabel", {
        Parent = TitleBar,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = Title or Config.Name,
        TextColor3 = Config.Theme.Text,
        Font = Enum.Font.SourceSansBold,
        TextSize = 28,
        TextXAlignment = Enum.TextXAlignment.Center,
        Position = UDim2.new(0, 0, 0, 0),
    })

    -- Minimize Button (positioned right)
    State.MinimizeButton = CreateInstance("TextButton", {
        Name = "MinimizeButton",
        Parent = TitleBar,
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 30, 1, 0),
        Position = UDim2.new(1, -30, 0, 0),
        Text = "-",
        TextColor3 = Config.Theme.Text,
        Font = Enum.Font.SourceSansBold,
        TextSize = 20,
    })

    pcall(function()
        State.MinimizeButton.MouseButton1Click:Connect(function()
            ToggleMinimize()
        end)
    end)

    SetupDragging(TitleBar, MainFrame)
    
    ----------------------------------------------------------------------
    -- **NEW SEARCH IMPLEMENTATION**
    ----------------------------------------------------------------------
    
    -- **Search Icon Button (Left side of TitleBar)**
    State.SearchIcon = CreateInstance("ImageButton", {
        Name = "SearchIcon",
        Parent = TitleBar,
        BackgroundTransparency = 1,
        Image = "rbxassetid://3067822501", -- A common magnifying glass icon ID
        ImageColor3 = Config.Theme.Text,
        Size = UDim2.new(0, 30, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
    })

    -- **Search Bar Frame (The GUI behind the icon)**
    State.SearchFrame = CreateInstance("Frame", {
        Name = "SearchFrame",
        Parent = TitleBar,
        BackgroundColor3 = Color3.fromRGB(50, 50, 50),
        Size = UDim2.new(1, -60, 0, Config.Theme.TitleHeight * 0.7), -- Width of TitleBar - 60 (30 for icon, 30 for minimize)
        Position = State.SearchFrameHiddenPos, -- Start hidden/tweened out
        BorderSizePixel = 0,
    })
    ApplyCorner(State.SearchFrame)
    
    -- **Search Textbox**
    State.SearchTextBox = CreateInstance("TextBox", {
        Name = "SearchTextBox",
        Parent = State.SearchFrame,
        BackgroundColor3 = Color3.fromRGB(50, 50, 50),
        BackgroundTransparency = 0.3,
        Size = UDim2.new(1, -2 * Config.Theme.Padding, 1, 0),
        Position = UDim2.new(0, Config.Theme.Padding, 0, 0),
        Text = "",
        PlaceholderText = "Search elements (TextButton, TextBox, Frame, etc)...",
        TextColor3 = Config.Theme.Text,
        Font = Enum.Font.SourceSans,
        TextSize = 14,
        ClearTextOnFocus = false,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    ApplyCorner(State.SearchTextBox)
    
    -- Connect icon click to tween the search bar and focus the textbox
    pcall(function()
        State.SearchIcon.MouseButton1Click:Connect(function()
            **ToggleSearchBar**(State.SearchFrame.Position == State.SearchFrameHiddenPos)
        end)
    end)
    
    -- Connect focus lost to run the search and hide the bar
    pcall(function()
        State.SearchTextBox.FocusLost:Connect(function(enterPressed)
            if enterPressed and #State.SearchTextBox.Text > 0 then
                **SearchGUI**(State.SearchTextBox.Text)
            end
            **ToggleSearchBar**(false) -- Hide the search bar after use
        end)
    end)
    
    ----------------------------------------------------------------------
    -- END NEW SEARCH IMPLEMENTATION
    ----------------------------------------------------------------------

    -- 4. Tab Container (Left side)
    State.TabFrame = CreateInstance("Frame", {
        Name = "TabFrame",
        Parent = MainFrame,
        BackgroundColor3 = Config.Theme.Frame,
        BackgroundTransparency = 1,
        Size = UDim2.new(0, Config.Theme.TabWidth, 1, -Config.Theme.TitleHeight),
        Position = UDim2.new(0, 0, 0, Config.Theme.TitleHeight),
        BorderSizePixel = 0,
    })
    
    -- 5. Page Container (Right side)
    State.PageContainer = CreateInstance("Frame", {
        Name = "PageContainer",
        Parent = MainFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -Config.Theme.TabWidth, 1, -Config.Theme.TitleHeight),
        Position = UDim2.new(0, Config.Theme.TabWidth, 0, Config.Theme.TitleHeight),
        BorderSizePixel = 0,
    })
    
    return Library
end

function Library.SwitchPage(PageName, Button)
    pcall(function()
        for Name, PageObj in pairs(State.Pages) do
            if PageObj and PageObj.Page then
                PageObj.Page.Visible = (Name == PageName)
            end
        end
        
        if State.CurrentTabButton then
            State.CurrentTabButton.BackgroundTransparency = Config.Theme.Transparency + 0.1 -- Uses 0.650 + 0.1
        end
        if Button then
            Button.BackgroundTransparency = Config.Theme.Transparency -- Uses 0.650
            State.CurrentTabButton = Button
        end
    end)
end

----------------------------------------------------------------------
-- PAGE OBJECT (Element Stacker)
----------------------------------------------------------------------

local PageModule = {}

function PageModule.New(PageName)
    local Self = setmetatable({
        Name = PageName,
        YOffset = Config.Theme.Padding,
        Elements = {},  
    }, {__index = PageModule})
    
    Self.Page = CreateInstance("ScrollingFrame", {
        Name = PageName .. "Page",
        Parent = State.PageContainer,
        BackgroundTransparency = 1,  
        Size = UDim2.new(1, 0, 1, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        Active = true,
        Visible = false,
        ScrollBarImageColor3 = Color3.fromRGB(200, 200, 200),
        ScrollBarThickness = 6,
    })
    
    function Self:GetNextPosition(HeightMultiplier)
        local TotalHeight = Config.Theme.ElementHeight * (HeightMultiplier or 1) + Config.Theme.Padding
        local Pos = UDim2.new(0, Config.Theme.Padding, 0, Self.YOffset)
        
        Self.YOffset = Self.YOffset + TotalHeight
        Self.Page.CanvasSize = UDim2.new(0, 0, 0, Self.YOffset + Config.Theme.Padding)
        
        return Pos
    end
    
    State.Pages[PageName] = Self
    
    return Self
end

function Library.NewTab(PageName)
    -- If group is required and user is not in group, don't create tabs for main GUI
    if State.RequiredGroupId and not State.IsInGroup then
        return { 
            AddButton = function() return end, 
            AddToggle = function() return end, 
            AddSlider = function() return end, 
            AddTextbox = function() return end, 
            AddDropdown = function() return end, 
            AddGroupVerification = function() return end 
        }
    end
    
    local PageCount = 0
    pcall(function()
        PageCount = #State.TabFrame:GetChildren()
    end)
    
    local TabButton = CreateInstance("TextButton", {
        Name = PageName .. "Tab",
        Parent = State.TabFrame,
        BackgroundColor3 = Config.Theme.Frame,
        Size = UDim2.new(1, 0, 0, Config.Theme.ElementHeight),
        Position = UDim2.new(0, 0, 0, PageCount * Config.Theme.ElementHeight),
        Text = PageName,
        TextColor3 = Config.Theme.Text,
        Font = Enum.Font.SourceSansBold,
        TextSize = 15,
        BorderSizePixel = 0,
    })
    
    local Page = PageModule.New(PageName)
    
    pcall(function()
        TabButton.MouseButton1Click:Connect(function()
            Library.SwitchPage(PageName, TabButton)
        end)
    end)
    
    if PageCount == 0 then
        Library.SwitchPage(PageName, TabButton)
    else
        TabButton.BackgroundTransparency = Config.Theme.Transparency + 0.1 -- Uses 0.650 + 0.1
    end
    
    return Page 
end

----------------------------------------------------------------------
-- ELEMENT BUILDERS (omitted for brevity, assume code from before)
----------------------------------------------------------------------
-- ... (PageModule:AddButton, AddToggle, AddSlider, AddTextbox, AddDropdown) ...

return Library
